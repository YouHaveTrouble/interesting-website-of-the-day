---
export const prerender = false;
import mysql from 'mysql';

async function getRandomUrl(): Promise<string | null> {
  return new Promise((resolve, reject) => {
    try {
      const connection = mysql.createConnection({
        host: import.meta.env.DB_HOST,
        port: import.meta.env.DB_PORT,
        user: import.meta.env.DB_USER,
        password: import.meta.env.DB_PASSWORD,
        database: import.meta.env.DB_DATABASE,
      });

      connection.connect();

      connection.query('SELECT url FROM websites ORDER BY RAND() LIMIT 1;', (err, result) => {
        if (err) {
          connection.end();
          return reject(err);
        }
        connection.end();
        resolve(result[0]?.url || null);
      });
    } catch (e) {
      resolve(null);
    }
  });
}

const url = await getRandomUrl();

if (url !== null) {
  return Astro.redirect(url);
}

Astro.response.status = 500;

---
